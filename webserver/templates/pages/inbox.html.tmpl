{{define "inbox"}}
    <div class="inbox">
        <form class="search-box" action="/" method="GET">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" name="q" placeholder="Search chats..." value="{{.Query}}" autocomplete="off">
            {{if or .Query .ActiveTags}}
                <a href="/" class="clear-btn" title="Clear all filters">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6 6 18M6 6l12 12"/>
                    </svg>
                </a>
            {{end}}
            {{range .ActiveTags}}<input type="hidden" name="tag" value="{{.}}">{{end}}
        </form>

        {{if .ActiveTags}}
            <div class="filters">
                {{range .ActiveTags}}
                    <span class="tag">
                        {{.}}
                        <button type="button" class="remove" onclick="removeFilter('tag', '{{.}}')" title="Remove">Ã—</button>
                    </span>
                {{end}}
                <form class="tag-input-form" onsubmit="addTagFilter(event)">
                    <input type="text" id="tagFilterInput" placeholder="Add tag..." pattern="[a-zA-Z0-9-_]+">
                </form>
            </div>
        {{end}}

        {{if .Chats}}
            <div class="chat-list">
                {{range .Chats}}
                    <a href="/chat/{{.ID}}" class="chat-item">
                        <div class="chat-item-header">
                            <span class="chat-item-title">{{if and .Metadata .Metadata.Title}}{{.Metadata.Title}}{{else}}Chat {{.ID}}{{end}}</span>
                            <div class="chat-item-meta">
                                <span>{{.FormattedTime}}</span>
                                <button class="delete-btn" onclick="deleteChat('{{.ID}}', event)" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {{if .Tags}}
                            <div class="chat-item-tags">
                                {{range .Tags}}
                                    <span class="tag clickable" onclick="addFilter('tag', '{{.}}', event)">{{.}}</span>
                                {{end}}
                            </div>
                        {{end}}
                        {{if .Files}}
                            <div class="chat-item-files">
                                {{$max := 4}}
                                {{range $i, $f := .Files}}
                                    {{if lt $i $max}}<span class="file-badge">{{$f}}</span>{{end}}
                                {{end}}
                                {{if gt (len .Files) $max}}<span class="file-badge">+{{sub (len .Files) $max}} more</span>{{end}}
                            </div>
                        {{end}}
                        <div class="chat-item-preview">
                            {{if .Metadata}}
                                {{range .Metadata.Messages}}
                                    {{if eq (.Message.Role | messageRole) "user"}}{{.Message.Content}}{{break}}{{end}}
                                {{end}}
                            {{end}}
                        </div>
                    </a>
                {{end}}
            </div>
            {{template "pagination" .}}
        {{else}}
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <p>No chats found</p>
            </div>
        {{end}}
    </div>

    <script>
     function addFilter(type, value, event) {
         event.preventDefault();
         event.stopPropagation();
         const url = new URL(window.location.href);
         url.searchParams.append(type, value);
         url.searchParams.delete('page_token');
         window.location.href = url.toString();
     }

     function addTagFilter(event) {
         event.preventDefault();
         const input = document.getElementById('tagFilterInput');
         if (input.value.trim()) {
             const url = new URL(window.location.href);
             url.searchParams.append('tag', input.value.trim());
             url.searchParams.delete('page_token');
             window.location.href = url.toString();
         }
     }

     function removeFilter(type, value) {
         const url = new URL(window.location.href);
         const params = url.searchParams.getAll(type);
         url.searchParams.delete(type);
         url.searchParams.delete('page_token');
         params.forEach(p => { if (p !== value) url.searchParams.append(type, p); });
         window.location.href = url.toString();
     }
    </script>
{{end}}
