{{define "chat"}}
    <div class="chat-view">
        <div class="chat-meta">
            <div class="chat-meta-row">
                <span>ID: <span class="chat-id copyable" title="Click to copy">{{.Chat.ID}}</span></span>
                <span>{{.Chat.FormattedTime}}</span>
            </div>

            <div class="chat-tags-row">
                {{if .Chat.Tags}}
                    <div class="chat-tags">
                        {{range .Chat.Tags}}
                            <span class="tag">
                                {{.}}
                                <button type="button" class="remove" onclick="removeTag('{{$.Chat.ID}}', '{{.}}')" title="Remove">Ã—</button>
                            </span>
                        {{end}}
                    </div>
                {{end}}
                <form class="tag-form" action="/chat/{{.Chat.ID}}/tags" method="POST">
                    <input type="text" name="tag" placeholder="Add tag..." pattern="[a-zA-Z0-9-_]+" id="newTagInput">
                    <button type="submit">Add</button>
                </form>
            </div>

            <div class="chat-meta-row">
                {{if .Chat.Files}}
                    <div class="chat-files">
                        {{range .Chat.Files}}
                            <span class="file-badge">{{.}}</span>
                        {{end}}
                    </div>
                {{end}}
            </div>
        </div>

        <div class="messages">
            {{if .Chat.Metadata}}
                {{range .Chat.Metadata.Messages}}
                    <div class="message {{.Message.Role | messageRole}}">
                        {{if .Message.Reasoning}}
                            <div class="reasoning-block">
                                <button type="button" class="reasoning-toggle" onclick="toggleReasoning(this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m9 18 6-6-6-6"/>
                                    </svg>
                                    Reasoning
                                </button>
                                <div class="reasoning-content">{{.Message.Reasoning | formatMessage}}</div>
                            </div>
                        {{end}}
                        <div class="message-content">{{- .Message.Content | formatMessage -}}</div>
                    </div>
                {{end}}
            {{end}}
        </div>
    </div>

    <script>
     async function removeTag(chatId, tag) {
         try {
             const res = await fetch('/chat/' + chatId + '/tags/' + encodeURIComponent(tag), { method: 'DELETE' });
             if (res.ok) window.location.reload();
         } catch (e) { console.error(e); }
     }

     document.getElementById('newTagInput')?.focus();
    </script>
{{end}}
